DROP DATABASE IF EXISTS elearning_db;
CREATE DATABASE elearning_db;
USE elearning_db;

CREATE TABLE Usuario (
    idUsuario INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    correo VARCHAR(150) NOT NULL UNIQUE,
    contrasena VARCHAR(255) NOT NULL,
    rol VARCHAR(20) NOT NULL DEFAULT 'estudiante',
    avatar VARCHAR(255) NULL,
    CONSTRAINT chk_rol CHECK (rol IN ('estudiante', 'docente', 'admin'))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE Curso (
    idCurso INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT NOT NULL,
    categoria VARCHAR(80) NOT NULL,
    imagenUrl VARCHAR(255) NULL,
    idDocente INT NOT NULL,
    fechaCreacion DATE DEFAULT (CURRENT_DATE),
    FOREIGN KEY (idDocente) REFERENCES Usuario(idUsuario) ON DELETE CASCADE
);

CREATE TABLE Modulo (
    idModulo INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(150) NOT NULL,
    descripcion TEXT,
    orden INT NOT NULL,
    idCurso INT NOT NULL,
    FOREIGN KEY (idCurso) REFERENCES Curso(idCurso) ON DELETE CASCADE
);

CREATE TABLE Material (
    idMaterial INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    tipo VARCHAR(30) NOT NULL,
    url VARCHAR(255) NOT NULL,
    duracionMinutos INT NULL,
    idModulo INT NOT NULL,
    FOREIGN KEY (idModulo) REFERENCES Modulo(idModulo) ON DELETE CASCADE
);

CREATE TABLE Inscripcion (
    idUsuario INT NOT NULL,
    idCurso INT NOT NULL,
    fechaInscripcion DATE DEFAULT (CURRENT_DATE),
    progresoPorcentaje INT DEFAULT 0,
    PRIMARY KEY (idUsuario, idCurso),
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario) ON DELETE CASCADE,
    FOREIGN KEY (idCurso) REFERENCES Curso(idCurso) ON DELETE CASCADE
);

CREATE TABLE ProgresoMaterial (
    idUsuario INT NOT NULL,
    idMaterial INT NOT NULL,
    completado BOOLEAN DEFAULT FALSE,
    fechaCompletado DATETIME NULL,
    PRIMARY KEY (idUsuario, idMaterial),
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario) ON DELETE CASCADE,
    FOREIGN KEY (idMaterial) REFERENCES Material(idMaterial) ON DELETE CASCADE
);

CREATE TABLE Evaluacion (
    idEvaluacion INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    descripcion TEXT,
    fechaInicio DATETIME NOT NULL,
    fechaFin DATETIME NOT NULL,
    idCurso INT NOT NULL,
    FOREIGN KEY (idCurso) REFERENCES Curso(idCurso) ON DELETE CASCADE
);

CREATE TABLE Pregunta (
    idPregunta INT AUTO_INCREMENT PRIMARY KEY,
    idEvaluacion INT NOT NULL,
    textoPregunta TEXT NOT NULL,
    tipo ENUM('opcion_multiple', 'verdadero_falso', 'abierta') NOT NULL,
    puntos INT DEFAULT 10,
    FOREIGN KEY (idEvaluacion) REFERENCES Evaluacion(idEvaluacion) ON DELETE CASCADE
);

CREATE TABLE Opcion (
    idOpcion INT AUTO_INCREMENT PRIMARY KEY,
    idPregunta INT NOT NULL,
    texto VARCHAR(255) NOT NULL,
    esCorrecta BOOLEAN NOT NULL,
    FOREIGN KEY (idPregunta) REFERENCES Pregunta(idPregunta) ON DELETE CASCADE
);

CREATE TABLE RespuestaEstudiante (
    idRespuesta INT AUTO_INCREMENT PRIMARY KEY,
    idPregunta INT NOT NULL,
    idUsuario INT NOT NULL,
    respuestaTexto TEXT NULL,
    idOpcionSeleccionada INT NULL,
    correcta BOOLEAN NULL,
    FOREIGN KEY (idPregunta) REFERENCES Pregunta(idPregunta) ON DELETE CASCADE,
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario) ON DELETE CASCADE
);

CREATE TABLE Certificado (
    idCertificado INT AUTO_INCREMENT PRIMARY KEY,
    idUsuario INT NOT NULL,
    idCurso INT NOT NULL,
    fechaEmision DATE DEFAULT (CURRENT_DATE),
    codigoVerificacion VARCHAR(50) UNIQUE,
    urlPDF VARCHAR(255),
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario),
    FOREIGN KEY (idCurso) REFERENCES Curso(idCurso)
);

CREATE TABLE Foro (
    idForo INT AUTO_INCREMENT PRIMARY KEY,
    tema VARCHAR(200) NOT NULL,
    idCurso INT NOT NULL,
    FOREIGN KEY (idCurso) REFERENCES Curso(idCurso) ON DELETE CASCADE
);

CREATE TABLE Mensaje (
    idMensaje INT AUTO_INCREMENT PRIMARY KEY,
    contenido TEXT NOT NULL,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    idForo INT NOT NULL,
    idUsuario INT NOT NULL,
    FOREIGN KEY (idForo) REFERENCES Foro(idForo) ON DELETE CASCADE,
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario) ON DELETE CASCADE
);

INSERT INTO Usuario (nombre, correo, contrasena, rol) VALUES
('Admin Test', 'admin@test.com', '$2b$10$9.5f4r3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a', 'admin'),
('Docente Test', 'docente@test.com', '$2b$10$9.5f4r3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a', 'docente'),
('Estudiante Test', 'estudiante@test.com', '$2b$10$9.5f4r3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c8b7a6f5e4d3c2b1a', 'estudiante');

INSERT INTO Curso (titulo, descripcion, categoria, idDocente) VALUES
('Curso Test', 'Curso de prueba minimal', 'test', 2);

INSERT INTO Modulo (titulo, descripcion, orden, idCurso) VALUES
('Módulo Test', 'Módulo de prueba', 1, 1);

INSERT INTO Material (titulo, tipo, url, idModulo) VALUES
('Material Test', 'pdf', '/uploads/test.pdf', 1);

INSERT INTO Inscripcion (idUsuario, idCurso) VALUES
(3, 1);

INSERT INTO Foro (tema, idCurso) VALUES
('Foro Test', 1);
